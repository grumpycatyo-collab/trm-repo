<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NFT AR Minigame - Sequential Scan</title>

<!-- A-Frame + AR.js (NFT build) -->
<script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

<style>
  html,body { height:100%; margin:0; overflow:hidden; font-family: Inter, Arial, sans-serif; }
  .arjs-loader {
    height:100%; width:100%; position: absolute; top:0; left:0;
    background:rgba(0,0,0,0.85); z-index:9999; display:flex;
    align-items:center; justify-content:center; color:white; font-size:1.2rem;
  }
  #ui {
    position: absolute; left: 10px; bottom: 10px; z-index: 10000; color: #e6e6e6;
    max-width: 420px; background: rgba(10,10,10,0.7); padding: 12px; border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  #message { margin-bottom: 8px; font-size: 0.95rem; line-height: 1.4; }
  .btn {
    background:#0f1724; border:1px solid #4b5563; color:#fff;
    padding:8px 10px; border-radius:6px; cursor:pointer; margin-right:6px;
    font-size:0.9rem;
  }
  .btn:active { transform:translateY(1px); }
  .small { font-size:0.85rem; color:#cbd5e1; margin-top:8px; }
  .success { color: #4ade80; font-weight: bold; }
  .error { color: #f87171; font-weight: bold; }
</style>
</head>
<body>

<div class="arjs-loader" id="loader">Loading AR experience ‚Äî please wait...</div>

<!-- UI Overlay -->
<div id="ui">
  <div id="message">Point your camera at the <strong>Winter Landscape (Snow)</strong> image to begin.</div>
  <div class="small">Progress: <span id="progress">0/3</span> | Current: <span id="currentMarker">none</span></div>
  <div style="margin-top:8px;">
    <button class="btn" id="restartBtn">Restart</button>
  </div>
</div>

<!-- A-Frame scene -->
<a-scene
  arjs="trackingMethod: best; debugUIEnabled: true;"
  vr-mode-ui="enabled: false"
  renderer="logarithmicDepthBuffer: true;"
  embedded
>
  <a-assets>
    <a-asset-item id="snow-model" src="assets/3d/snow/scene.gltf"></a-asset-item>
    <a-asset-item id="fire-model" src="assets/3d/fire/scene.gltf"></a-asset-item>
    <a-asset-item id="tree-model" src="assets/3d/christmas_tree/scene.gltf"></a-asset-item>
  </a-assets>

  <a-entity light="type: ambient; intensity: 0.5"></a-entity>
  <a-entity light="type: directional; intensity: 0.8; position: 1 1 1"></a-entity>

  <!-- Winter Landscape (Snow) marker - FIRST -->
  <a-nft
    id="marker-snow"
    type="nft"
    url="assets/nft/winter-pixel-landscape-retro-2d-game-background-with-snowy-mountains-and-forest-snowy-landscape-with-frozen-lake-winter-panorama-vector"
  >
    <a-entity
      id="model-snow"
      gltf-model="#snow-model"
      scale="50 50 50"
      position="10 0 0"
      rotation="90 -180 0"
      visible="false"
    ></a-entity>
  </a-nft>

  <!-- Fire marker - SECOND -->
  <a-nft
    id="marker-fire"
    type="nft"
    url="assets/nft/7854a07267f4e0b92e7aa01329ba78af"
  >
    <a-entity
      id="model-fire"
      gltf-model="#fire-model"
      scale="15 15 15"
      position="7 20 0"
      rotation="-90 0 0"
      visible="false"
    ></a-entity>
  </a-nft>

  <!-- Cozy Place (Tree) marker - THIRD -->
  <a-nft
    id="marker-tree"
    type="nft"
    url="assets/nft/78961a9a72a0c738d06ab7d8764779c7"
  >
    <a-entity
      id="model-tree"
      gltf-model="#tree-model"
      scale="100 100 100"
      position="1 1 0"
      rotation="-90 0 0"
      visible="false"
    ></a-entity>
  </a-nft>

  <!-- camera -->
  <a-entity camera position="0 0 0" fov="80"></a-entity>
</a-scene>

<script>
/* -------------------------
   Game state machine
   -------------------------
   States:
     - idle (waiting for first marker)
     - snowScanned (1/3 complete)
     - fireScanned (2/3 complete)
     - complete (all 3 scanned in order)
*/

const UI = {
  message: document.getElementById('message'),
  progress: document.getElementById('progress'),
  currentMarkerLabel: document.getElementById('currentMarker'),
  loader: document.getElementById('loader'),
  restartBtn: document.getElementById('restartBtn'),
};

// Game variables
let state = "idle";
let currentActiveMarker = null;
let scannedCount = 0;

// Expected sequence
const EXPECTED_SEQUENCE = ['marker-snow', 'marker-fire', 'marker-tree'];

// Marker friendly names
const markerNames = {
  'marker-snow': '‚ùÑÔ∏è Snow (Winter Landscape)',
  'marker-fire': 'üî• Fire (NFT #7854)',
  'marker-tree': 'üéÑ Tree (NFT #7861)'
};

// List all marker elements
const markers = [
  document.getElementById('marker-snow'),
  document.getElementById('marker-fire'),
  document.getElementById('marker-tree')
];

// Hide loader after a delay
setTimeout(() => {
  UI.loader.style.display = 'none';
}, 3000);

// Helper functions
function setMessage(txt) {
  UI.message.innerHTML = txt;
}

function updateProgress() {
  UI.progress.innerText = `${scannedCount}/3`;
}

function getNextExpectedMarker() {
  if (scannedCount < EXPECTED_SEQUENCE.length) {
    return EXPECTED_SEQUENCE[scannedCount];
  }
  return null;
}

function isCorrectMarker(markerId) {
  const expected = getNextExpectedMarker();
  return markerId === expected;
}

// Show marker model if it's the correct one in sequence
function showMarkerModel(markerId) {
  // Hide loader on first marker found
  UI.loader.style.display = 'none';

  // Update current marker label
  UI.currentMarkerLabel.innerText = markerNames[markerId] || markerId;

  // Check if this is the correct marker in sequence
  if (isCorrectMarker(markerId)) {
    // Correct marker!
    const markerEl = document.getElementById(markerId);
    const model = markerEl.querySelector('a-entity[gltf-model]');
    if (model) model.setAttribute('visible', 'true');

    currentActiveMarker = markerId;
    handleCorrectMarker(markerId);
  } else {
    // Wrong marker!
    handleWrongMarker(markerId);
  }
}

// Clear active marker (on markerLost)
function clearActiveMarker(markerId) {
  if (currentActiveMarker === markerId) {
    const markerEl = document.getElementById(markerId);
    const model = markerEl.querySelector('a-entity[gltf-model]');
    if (model) model.setAttribute('visible', 'false');
    currentActiveMarker = null;
    UI.currentMarkerLabel.innerText = 'none';
  }
}

// Handle when correct marker is scanned
function handleCorrectMarker(markerId) {
  scannedCount++;
  updateProgress();

  switch (markerId) {
    case 'marker-snow':
      state = 'snowScanned';
      setMessage('<span class="success">‚úì Correct!</span> Snow scanned (1/3). Now scan the <strong>üî• Fire</strong> image.');
      break;

    case 'marker-fire':
      state = 'fireScanned';
      setMessage('<span class="success">‚úì Correct!</span> Fire scanned (2/3). Now scan the <strong>üéÑ Tree</strong> image.');
      break;

    case 'marker-tree':
      state = 'complete';
      setMessage('<span class="success">üéâ SUCCESS!</span> You scanned all three markers in the correct order! Well done!');
      break;
  }
}

// Handle when wrong marker is scanned
function handleWrongMarker(markerId) {
  const expected = getNextExpectedMarker();
  const expectedName = markerNames[expected];
  const scannedName = markerNames[markerId];

  setMessage(`<span class="error">‚úó Wrong order!</span> You scanned ${scannedName}, but you need to scan ${expectedName} next. Please scan in order: ‚ùÑÔ∏è Snow ‚Üí üî• Fire ‚Üí üéÑ Tree`);
}

// Restart game
function restartGame() {
  scannedCount = 0;
  state = 'idle';
  currentActiveMarker = null;

  // Hide all models
  document.querySelectorAll('a-entity[gltf-model]').forEach(el => {
    el.setAttribute('visible', 'false');
  });

  updateProgress();
  setMessage('Game restarted. Point your camera at the <strong>‚ùÑÔ∏è Winter Landscape (Snow)</strong> image to begin.');
  UI.currentMarkerLabel.innerText = 'none';
}

/* ---------- Marker found / lost listeners ---------- */
markers.forEach(markerEl => {
  if (!markerEl) return;

  markerEl.addEventListener('markerFound', () => {
    const id = markerEl.id;
    console.log('Found marker:', id);
    showMarkerModel(id);
  });

  markerEl.addEventListener('markerLost', () => {
    const id = markerEl.id;
    console.log('Lost marker:', id);
    clearActiveMarker(id);
  });
});

// Hook restart button
UI.restartBtn.addEventListener('click', restartGame);

// Initialize
updateProgress();

// Fallback to remove loader
window.addEventListener('arjs-video-loaded', () => {
  UI.loader.style.display = 'none';
});

setTimeout(() => {
  if (UI.loader.style.display !== 'none') {
    UI.loader.style.display = 'none';
  }
}, 10000);

</script>
</body>
</html>
